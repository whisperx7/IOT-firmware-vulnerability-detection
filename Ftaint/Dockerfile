FROM ubuntu:xenial

RUN dpkg --add-architecture i386 && \
    apt-get update && \ 
    apt-get install -y virtualenvwrapper python2.7-dev build-essential libxml2-dev libxslt1-dev git libffi-dev cmake libreadline-dev libtool debootstrap debian-archive-keyring libglib2.0-dev libpixman-1-dev libqt4-dev graphviz-dev binutils-multiarch nasm libc6:i386 libgcc1:i386 libstdc++6:i386 libtinfo5:i386 zlib1g:i386 vim python-pip libssl-dev curl tmux net-tools software-properties-common dirmngr apt-transport-https lsb-release ca-certificates && \
    curl -sL https://deb.nodesource.com/setup_10.x | bash - && \
    add-apt-repository -y ppa:openjdk-r/ppa && \
    apt-get update

RUN apt-get install -y nodejs openjdk-11-jdk

RUN useradd -s /bin/bash -m ftaint

COPY --chown=ftaint:ftaint src /home/ftaint/ftaint/
WORKDIR /home/ftaint/ftaint/jsparse

RUN npm install

RUN su - ftaint -c "source /usr/share/virtualenvwrapper/virtualenvwrapper.sh && \ 
                mkvirtualenv ftaint && \
                pip install -r ~/ftaint/requirements.txt && \
		        tar -xvf /home/ftaint/deps/angr-dev.tar.xz -C /home/ftaint/deps/ && \
                /home/ftaint/deps/angr-dev/setup.sh && \
                pip install pyelftools==0.24 && \
                tar -xvf /home/ftaint/deps/ghidra.tar.xz -C /home/ftaint/ftaint/ && \
                echo 'workon ftaint' >> /home/ftaint/.bashrc"

ADD init.sh /home/ftaint/ftaint

ENTRYPOINT /home/ftaint/ftaint/init.sh
